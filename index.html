<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Promille Rechner</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0a84ff">
  <style>
    :root{--bg:#f7f7f7;--card:#fff;--text:#111;--muted:#666;--primary:#0a84ff;--danger:#d9534f;--radius:14px}
    @media (prefers-color-scheme: dark){:root{--bg:#0b0b0b;--card:#1a1a1a;--text:#f2f2f2;--muted:#aaa}}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);
      padding:env(safe-area-inset-top) 12px calc(12px + env(safe-area-inset-bottom))}
    .wrap{max-width:720px;margin:0 auto}
    h1{font-size:1.4rem;margin:8px 4px 10px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.06);margin-bottom:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    label{display:inline-flex;align-items:center;gap:6px;margin:6px 8px 6px 0}
    input,select,button{font-size:1rem;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.1);background:#fff}
    @media (prefers-color-scheme: dark){input,select,button{background:#121212;border-color:rgba(255,255,255,.12);color:var(--text)}}
    button{background:var(--primary);border:none;color:#fff;min-height:44px}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,.12)}
    #resetBtn{background:var(--danger)}
    .prom{font-size:1.8rem;font-weight:700;margin:10px 4px 6px}
    .muted{color:var(--muted)}
    .entry{margin-bottom:8px}
    small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Promille Rechner</h1>

    <!-- Benutzer-Einstellungen -->
    <div class="card">
      <div class="row">
        <label>Gewicht:
          <input type="number" id="gewichtInput" inputmode="decimal" min="40" max="200" step="1" style="width:110px"> kg
        </label>
        <!-- optional: andere Verteilungszahl sp√§ter ausw√§hlbar -->
        <label>Verteilungsfaktor:
          <select id="rInput">
            <option value="0.68" selected>0,68 (Standard)</option>
            <option value="0.55">0,55 (niedriger)</option>
            <option value="0.75">0,75 (h√∂her)</option>
          </select>
        </label>
      </div>
      <small>Gewicht &amp; Faktor werden lokal gespeichert.</small>
    </div>

    <!-- Eingabe Getr√§nke -->
    <div class="card">
      <div class="row">
        <label>Getr√§nk:
          <select id="drinkType">
            <option value="bier">Bier (5%)</option>
            <option value="radler">Radler (2.5%)</option>
          </select>
        </label>
        <label>Menge:
          <select id="drinkSize">
            <option value="0.3">0,3 L</option>
            <option value="0.4">0,4 L</option>
            <option value="0.5" selected>0,5 L</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button id="addDrinkBtn">Jetzt getrunken</button>
        <button id="addPlanBtn" class="ghost">F√ºr sp√§ter planen</button>
        <button id="resetBtn" class="ghost">Zur√ºcksetzen</button>
      </div>
    </div>

    <div class="prom" id="promilleAnzeige">Aktuelle Promille: 0,00‚Ä∞</div>

    <div id="log" class="card">
      <b>Getrunkene Getr√§nke</b>
      <div class="muted" id="emptyLog">Noch nichts erfasst.</div>
    </div>

    <div id="plan" class="card">
      <b>Geplante Getr√§nke</b>
      <div class="muted" id="emptyPlan">Keine geplant.</div>
    </div>

    <div class="card"><small>Offline nutzbar, Daten bleiben im Browser gespeichert.</small></div>
  </div>

  <script>
    // ---------- Einstellungen laden/speichern ----------
    const nf = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const S = {
      get gewicht(){ return +(localStorage.getItem('pr_gewicht') || 80); },
      set gewicht(v){ localStorage.setItem('pr_gewicht', String(v)); },
      get r(){ return +(localStorage.getItem('pr_r') || 0.68); },
      set r(v){ localStorage.setItem('pr_r', String(v)); }
    };

    // ---------- Daten ----------
    let drinks = [];
    let plans  = [];

    function saveData(){
      localStorage.setItem('pr_drinks', JSON.stringify(drinks));
      localStorage.setItem('pr_plans',  JSON.stringify(plans));
    }
    function loadData(){
      try {
        drinks = JSON.parse(localStorage.getItem('pr_drinks') || '[]');
        plans  = JSON.parse(localStorage.getItem('pr_plans')  || '[]');
      } catch(e){ drinks=[]; plans=[]; }
    }

    // ---------- Rechnen ----------
    const abbau = 0.13; // ‚Ä∞ pro Stunde
    function alkoholGramm(type, liter){
      const vol = (type === 'bier') ? 0.05 : 0.025;
      return liter * vol * 0.8 * 1000; // g
    }
    function promilleJetzt(){
      const now = Date.now();
      let x = 0;
      for(const d of drinks){
        const h = Math.max(0, (now - new Date(d.t)) / 36e5);
        const p = d.g / (S.gewicht * S.r) - h * abbau;
        x += Math.max(0, p);
      }
      return x;
    }

    // ---------- UI ----------
    function update(){
      // Promille
      document.getElementById('promilleAnzeige').textContent =
        'Aktuelle Promille: ' + nf.format(promilleJetzt()) + '‚Ä∞';

      // Log
      const L = document.getElementById('log');
      const emptyL = document.getElementById('emptyLog');
      L.querySelectorAll('.entry').forEach(e => e.remove());
      if(!drinks.length){ emptyL.style.display = 'block'; }
      else {
        emptyL.style.display = 'none';
        for(const d of drinks){
          const t = new Date(d.t).toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' });
          const div = document.createElement('div');
          div.className = 'entry';
          div.textContent = `üïí ${t}: ${nf.format(d.s)} L ${d.ty==='bier'?'Bier':'Radler'}`;
          L.appendChild(div);
        }
      }

      // Plan
      const P = document.getElementById('plan');
      const emptyP = document.getElementById('emptyPlan');
      P.querySelectorAll('.entry').forEach(e => e.remove());
      if(!plans.length){ emptyP.style.display = 'block'; }
      else {
        emptyP.style.display = 'none';
        plans.forEach((d,i)=>{
          const e = document.createElement('div');
          e.className = 'entry';
          const name = d.ty==='bier'?'Bier':'Radler';
          e.innerHTML = `üìÖ ${nf.format(d.s)} L ${name} <button class="ghost" data-i="${i}">Jetzt trinken</button>`;
          P.appendChild(e);
        });
        P.querySelectorAll('button.ghost').forEach(btn => btn.onclick = () => {
          const i = +btn.dataset.i;
          const it = plans.splice(i,1)[0];
          drinks.push({ ty: it.ty, s: it.s, g: alkoholGramm(it.ty,it.s), t: Date.now() });
          saveData(); update();
        });
      }
    }

    function bind(){
      // Initialwerte in Inputs setzen
      const gEl = document.getElementById('gewichtInput');
      const rEl = document.getElementById('rInput');
      gEl.value = S.gewicht;
      rEl.value = String(S.r);

      gEl.addEventListener('change', () => { S.gewicht = Math.max(40, Math.min(200, +gEl.value||80)); update(); });
      rEl.addEventListener('change', () => { S.r = +rEl.value || 0.68; update(); });

      document.getElementById('addDrinkBtn').addEventListener('click', () => {
        const ty = document.getElementById('drinkType').value;
        const s  = parseFloat(document.getElementById('drinkSize').value);
        drinks.push({ ty, s, g: alkoholGramm(ty,s), t: Date.now() });
        saveData(); update();
      });

      document.getElementById('addPlanBtn').addEventListener('click', () => {
        const ty = document.getElementById('drinkType').value;
        const s  = parseFloat(document.getElementById('drinkSize').value);
        plans.push({ ty, s }); saveData(); update();
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        if(confirm('Alles l√∂schen?')){
          drinks = []; plans = [];
          saveData(); update();
        }
      });
    }

    // Start
    loadData(); bind(); update();
    setInterval(update, 30000);
    
    // PWA: Service Worker registrieren (optional, wenn lokal / ohne Pages geladen => ignoriert)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
